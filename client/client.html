<html>
<head>
<title>PantherPoint Client</title>
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" />
<link rel="stylesheet" href="/index.css" />
</head>
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Client</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
          
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="true">Menu <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#">Leave host</a></li>
            <li><a href="#">Connect to multiple hosts</a></li>
          </ul>
        </li>
      </ul>
        <button class="btn btn-danger navbar-btn navbar-right"> Log out</button>
    </div><!--/.nav-collapse -->
  </div>
</nav>
<body class="container" style="margin-top: 70px">


<!-- This is the first view the user see -->
<div class="text-center" id="login">
    <p>Indtast password for at connecte til skærmen:</p>
    <input class="input-lg" type="text" value="" id="tekstfelt"><br><br>
    <p id="err_msg" style="color:red;"> <p>
    <p>Indtast dit navn:</p>
    <input class="input-sm" type="text" value="" id="navnefelt"><br><br>
    <input class="btn btn-primary glyphicon glyphicon-log-in" type="button" value="Connect" id="btn_connect">
    <br>
    <div id="log"></div>
</div>

<!-- This view is shown, when the user is connected to a host -->
<div class="text-center" id="none" style="display:none">
  <h1 id="host_name"> </h1>
  <div class="btn-group-vertical btn-lg">
    <button id="btn_chat" type="button" class="btn btn-primary btn-big"> Chat </button>
    <button id="btn_snakes" type="button" class="btn btn-primary btn-big"> Snake </button>
  </div>
</div>

<div class ="text-center" id="snake" style="display:none">
  <div class="btn-group btn-lg">
    <button id="left" type="button" class="btn btn-primary btn-big"> L </button>
    <button id="right" type="button" class="btn btn-primary btn-big"> R </button>

  </div>
</div>



<script src="/socket.io/socket.io.js"></script>
<script src="/linda/linda.js"></script>
<script src="/jquery/jquery.js"></script>
<script>
  var server_url = "http://localhost:3000";
  listOfViews = ["none","login","snake","chat"]

  var print = function(msg){
    $("#log").prepend( $("<p>").text(msg) );
  };

  var socket = io.connect(server_url);
  var linda = new Linda().connect(socket);
  var main

  linda.io.on("connect", function(){
    console.log("connected to distributing server " + server_url + "/main");
    main = linda.tuplespace("hosts")
  });

  var updateView = function (activity) {
    listOfViews.forEach(function (view) {
      if(view == activity){
        setTimeout(function() {
            $("#"+view).fadeIn();
            $("#"+view).show();
        }, 400);
      } else {
        $("#"+view).fadeOut();
        setTimeout(function() {
            $("#"+view).hide()
        }, 400);
        
      }
    })
  }

  var startWatchHost = function (ts, name) {
    var actWatch = ts.watch({type:"activity"},function(err,tuple){
      updateView(tuple.data.activity)
    });

    //Denne function sender en ny tuple, med
    var keepAlive = setInterval(function(){
      ts.replace({type: "player", name: name},{type: "player", name: name});
    },timeToKeepAlive);

    //Denne del sletter watch functioner, så de ikke kører mere, hvis host'en ikke er connected til tuple-spacet mere
    //Og sletter setInterval's
    var chekcHostAlive = setInterval(function(){
      ts.readp({type:"hostActive"}, function(err, tuple){
        if(tuple == null){
          ts.cancel(actWatch)
          clearInterval(keepAlive)
          clearInterval(checkHostAlive)
        }
      });
    },timeToKeepAlive);
  }

  // on page load
  $(function(){

    $("#btn_connect").click(function(){
      name = $("#navnefelt").val();
      code = $("#tekstfelt").val();
      main.readp({type: 'room', room: code}, function(err, tuple){
        if(tuple == null){
          $("#err_msg").html("Error: Room does not exist")
        } else {
          var room = linda.tuplespace(code);
            room.readp({type: 'player', name: name}, function(err2, tuple2){
                if(tuple2 !== null){
                    $("#err_msg").html("Error: Player name is already in room")
                } else {
                    room.write({type: "player", name: name});
                    $("#host_name").html("Connected to: "+code)
                    room.read({type:"activity"}, function(err1, tuple1){
                        updateView(tuple1.data.activity)
                    })
                }
            })
          }
        })
    });

    $(document).keypress(function(e) {
      if(e.which == 13) {
        $("#btn_connect").click()
      }
    });

  });
</script>

</body>
</html>
